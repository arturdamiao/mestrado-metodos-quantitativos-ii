---
title: "Replicação: A redução da maioridade penal diminui a violência? Evidências de um estudo comparado"
format: 
  html: 
    toc: true
    toc-depth: 2
    toc-location: left
    toc-title: "Sumário"
    reference-location: margin
#    footnotes-hover: true

author: 
  - name: Artur Damião
    email: arturcardoso@usp.br
    orcid: 0000-0002-8628-1653

date: today
date-format: "long"
number-sections: true

fig-cap-location: top
tbl-cap-location: top


lang: pt

# embed-resources: true

bibliography: referencias.bib

execute: 
  warning: false
  
---

# Introdução

O artigo de @lins2016 tem como objetivo investigar a possível associação entre a diminuição da maioridade penal e os níveis de violência em perspectiva comparada. Para tanto, os autores utilizaram de análise espacial, correlação de Pearson e de modelos de regressão linear de mínimos quadrados ordinários (MQO). 

Em termos de avanço do artigo original, propomos a interpretação das variáveis de controle, checagem dos pressupostos do modelo e teste de robustez. 


## Ambientação {.unnumbered}

Importando os pacotes necessários. 

```{r}
pacman::p_load(
  tidyverse,
  janitor,
  stargazer,
  rio,
  data.table,
  lmtest,
  sandwich,
  performance,
  knitr,
  modelsummary,
  broom
)
```

## Dados {.unnumbered}

Lendo a base de dados direto do Github:

```{r}
link <- "https://github.com/mgaldino/lab-regressao-aula/blob/main/trabalho%20final/4Lins_2016/maioridade.tab?raw=true"

df <- readRDS("../dados/maioridade-replicacao.rds")
```

Transformando as variáveis: 

```{r}
df <- df %>% 
  janitor::clean_names() %>% 
  dplyr::mutate(
    acr_cipriani = ifelse(acr_cipriani == 999, NA, acr_cipriani)
    )
```


# Hipóteses

O objetivo dos autores é testar a hipótese de que quanto menor a maioridade penal, menor o nível de violência. A @eq-regressao apresenta o modelo estimado: 

$$
Y = \alpha + \beta_1X_1 + \beta_2X_2 + \beta_3X_3 + \beta_4X_4 + \epsilon
$$ {#eq-regressao}

Onde, 

$Y$: Taxa de Homicídio por 100 mil habitantes (`homi_rate_unodc`)

$X_1$: Idade de Maioridade Penal ou Responsabilidade Criminal (`acm_hazel`, `acm_gv`, `acr_hazel` ou `acr_cipriani`)

$X_2$: Índice de Desenvolvimento Humano (`idh`)

$X_3$: Índice Gini (`ginmar_solt`)

$X_4$: Desemprego de longo termo (`desemprego_longo`)

Criando os modelos

```{r}
modelo_acm_hazel <- lm(homi_rate_unodc ~ acm_hazel + idh + desemprego_longo + ginmar_solt,
                       data = df)

modelo_acm_gv <- lm(homi_rate_unodc ~ acm_gv + idh + desemprego_longo + ginmar_solt,
                       data = df)

modelo_acr_hazel <- lm(homi_rate_unodc ~ acr_hazel + idh + desemprego_longo + ginmar_solt,
                       data = df)

modelo_acr_cipriani <- lm(homi_rate_unodc ~ acr_cipriani + idh + desemprego_longo + ginmar_solt,
                       data = df)
```

Apresentando os modelos:

```{r}
stargazer::stargazer(modelo_acm_hazel, modelo_acm_gv, modelo_acr_hazel, modelo_acr_cipriani,
                     type = "text",
                     title = "Resultados das Regressões",
                     dep.var.labels = c("Taxa de Homícidio (100 mil hab.)"),
                     covariate.labels = c("ACM Hazel", "ACM GV", "ACR Hazel","ACR Cipriani", "IDH", "Desemprego Longo", "Índice de Gini"))
```

# Interpretação dos coeficientes da regressão {#sec-interpretacao}

Os coeficientes negativos da Redução da Maioridade Penal (ACM) ou Responsabilização Criminal (ACR) indicam que quanto maior a idade penal, menor a taxa de homicídios. Dessa forma, rejeitamos a $H_1$ que $\text{menor maioridade = menor violência}$. Os modelos 2 (`acm_gv`) e 4 (`acr_cipriani`) não apresentam significância estatística, ao passo que os modelos 1 (`acm_hazel`) e 3 (`acr_hazel`) apresentam significância a um nível de 10% ($p < 0.1$). É um nível de significância fraco. A partir desses dados, não é possível afirmar que a redução da maioridade penal ou responsabilidade criminal diminui as taxas de homícidio. 

O Índice de Desenvolvimento Humano, ao contrário, apresenta grande significância estatística ($p<0.05$ e $p<0.01$), sendo a variável que mais explica a redução na taxa de homicídios. No primeiro modelo, a cada um ponto em que o IDH aumenta, reduz-se 13,788 pontos na taxa de homicídio; no segundo modelo, a cada aumento de um ponto no IDH, a taxa de homícidio reduz 28,974 ponto - redução semelhante para os modelos três (28,575 pontos) e quatro (29,454 pontos). 

O Desemprengo Longo também apresenta sinal negativo nos coeficientes, sugerindo que um maior grau de desemprego a longo prazo está associado a uma menor taxa de homicídios. Esse resultado, contraintuitivo, pode ser causado pelas características da nossa amostra (nosso $n$ varia entre 29 ou 37) ou colinearidade com outras variáveis (especificamente o IDH). 

Por fim, o Índice de Gini não apresentou nenhum valor significativo, sugerindo que a desigualdade não explica a variação da taxa de homicídio. Provavelmente isso se dá pelo $n$ pequeno. Ao interpretamos o $R^2$, vemos que nosso modelo explica, em média, `r (0.364 + 0.382 + 0.447 + 0.387)/4`% da variação nas taxas de homicídio. Ou seja, mais da metade da violência é causada por fatores que não estão em nossa equação. 

# Checagem dos modelos 

Nesta seção, avaliamos se os modelos atendem aos pressupostos da regressão linear: 

1. Colinearidade
1. Homocedasticidade
1. Normalidade dos resíduos 
1. 

## Colinearidade

A @tbl-vif sintetiza os valores de Variation Inflaction Factor, indicando que as variáveis são independentes entre si. Ou seja, elas contribuem de maneira distinta para o modelo. Os valores encontram-se significativamente abaixo do limite crítico de 5. Logo, desconsideramos a colinearidade suspeitada na @sec-interpretacao. 

```{r}
#| include: false

# 1. Extraindo os valores dos VIFs
vif1 <- car::vif(modelo_acm_hazel)
vif2 <- car::vif(modelo_acm_gv)
vif3 <- car::vif(modelo_acr_hazel)
vif4 <- car::vif(modelo_acr_cipriani)

# 2. Criando uma Tabela Unificada
tabela_vif <- data.frame(
  Variavel = c("Maioridade/Responsabilidade", "IDH", "Desemprego Longo", "Índice de Gini"),
  Modelo_1_ACM_Hazel = round(as.numeric(vif1), 2),
  Modelo_2_ACM_GV    = round(as.numeric(vif2), 2),
  Modelo_3_ACR_Hazel = round(as.numeric(vif3), 2),
  Modelo_4_ACR_Cipriani = round(as.numeric(vif4), 2)
)
```

```{r}
#| label: tbl-vif
#| echo: false

kable(tabela_vif,
      caption = "Tabela de Multicolinearidade (VIF)",
      align = "c",
      col.names = c("Variável",
                    "ACM Hazel (1)",
                    "ACM GV (2)",
                    "ACR Hazel (3)",
                    "ACR Cipriani (4)"))
```





## Homocedasticidade

A homocedasticidade pressupõe que os resíduos variem de forma constante ao longo dos valores previstos. Os gráficos da @fig-hetero apresentam que os erros não variam igualmente ao longo da reta. Logo, há a presença de heterocedasticidade. 

```{r}
#| label: fig-hetero
#| echo: false
#| layout-ncol: 2
#| fig-cap: "Checagem da Homocedasticidade"
#| fig-subcap:
#|   - "Modelo 1: ACM Hazel"
#|   - "Modelo 2: ACM GV"
#|   - "Modelo 3: ACR Hazel"
#|   - "Modelo 4: ACR Cipriani"


# 1. Plota apenas o gráfico de heterocedasticidade

plot(modelo_acm_hazel,    which = 3)
plot(modelo_acm_gv,       which = 3)
plot(modelo_acr_hazel,    which = 3)
plot(modelo_acr_cipriani, which = 3)

```

## Normalidade dos resíduos

O teste de normalidade dos resíduos, apresentado na @fig-normalidade, verifica se os resíduos do modelo seguem uma distribuição normal. Nosso gráfico abaixo indica que há uma assimetria nas pontas, sugerindo que nosso modelo erra mais para cima do que para baixo. 

```{r}
#| label: fig-normalidade
#| echo: false
#| layout-ncol: 2
#| fig-cap: "Checagem da Normalidade dos Resíduos (Q-Q Plot)"
#| fig-subcap:
#|   - "Modelo 1: ACM Hazel"
#|   - "Modelo 2: ACM GV"
#|   - "Modelo 3: ACR Hazel"
#|   - "Modelo 4: ACR Cipriani"


# 1. Plota apenas o gráfico de normalidade

plot(modelo_acm_hazel,    which = 2)
plot(modelo_acm_gv,       which = 2)
plot(modelo_acr_hazel,    which = 2)
plot(modelo_acr_cipriani, which = 2)

```
Isso se dá, provavelmente, pelo caráter da amostra. É mais provável que poucos países concentrem taxas de homicídios mais altas, enquanto a maior parte dos países da amostra de @lins2016 tem taxas baixas ou médias. Como o $n$ ($n <40$) amostral é relativamente pequeno, os poucos casos *outliers* distorcem a normalidade dos resíduos. 

# Analisando o erro padrão robusto

Para corrigir a heterocedasticidade presente nos modelos, utilizaremos os erros padrão robustos. Especificamente, utilizaremos o $HC3$, dado o tamanho de nossa amostra. O $HC3H$ é apropriado para amostras pequenas porque ele penaliza os *outliers*, evitando falsos positivos^[Parte dessa informação foi dada pelo professor Manoel Galdino. De forma complementar, perguntei ao Gemini por quê usar o $HC3$ ao invés do $HC1$ e comparei o resultado dos dois testes nos modelos. No $HC1$, algumas variáveis (como Índice de Desenvolvimento Humano), continuaram estatisticamente significativas. Com o $HC3$, nenhuma variável manteve sua significância.] A fórmula para o estimador $HC3$ é:

$$
\frac{\hat{u}_i^2} {(1- h_{ii})^2}
$$

Leia-se: o quadrado do resíduo da observação $i$, dividido pelo quadrado do complemento da alavancagem (*leverage*) dessa mesma observação.^[Pedi ajuda para o Gemini sobre como ler essa fórmula. Basicamente: o HC3 pega o erro que o modelo cometeu ($\hat{u}^2$) e o "infla" (aumenta) baseado no quanto aquela observação é influente ($h_{ii}$). Quanto mais próximo o $h$ estiver de 1, menor será o denominador e maior será o resultado total (a penalidade).]




```{r}
#| eval: false
#| include: false

## ACM_Hazel

coeftest(modelo_acm_hazel, vcov = vcovHC(modelo_acm_hazel, type = "HC3"))
```

A @tbl-acm-hazel-hc3 apresenta o erro robusto para o Modelo 1:

```{r}
#| label: tbl-acm-hazel-hc3
#| echo: false
#| tbl-cap: Estimativas do Modelo ACM Hazel com Erros Robustos (HC3)

acm_hazel_hc3 <- coeftest(modelo_acm_hazel, vcov = vcovHC(modelo_acm_hazel, type = "HC3"))

tidy(acm_hazel_hc3) %>%
  mutate(term = c("Constante", "Maioridade (Hazel)", "IDH", "Desemprego", "Gini")) %>%
  kable(digits = 3,
        col.names = c("Variável", 
                      "Estimativa", 
                      "Erro Padrão", 
                      "t", 
                      "p-valor"),
        align = "c")
```


A @tbl-acm-gv-hc1 apresenta o erro robusto para o Modelo 2:


```{r}
#| label: tbl-acm-gv-hc1
#| echo: false
#| tbl-cap: Estimativas do Modelo ACM GV com Erros Robustos (HC1)

acm_gv_hc1 <- coeftest(modelo_acm_gv, vcov = vcovHC(modelo_acm_gv, type = "HC1"))

tidy(acm_gv_hc1) %>%
  mutate(term = c("Constante", "Maioridade (GV)", "IDH", "Desemprego", "Gini")) %>%
  kable(digits = 3,
        col.names = c("Variável", 
                      "Estimativa", 
                      "Erro Padrão", 
                      "t", 
                      "p-valor"),
        align = "c")
```

A @tbl-acr-hazel-hc3 apresenta o erro robusto para o Modelo 3:


```{r}
#| label: tbl-acr-hazel-hc3
#| echo: false
#| tbl-cap: Estimativas do Modelo ACR Hazel com Erros Robustos (HC3)

acr_hazel_hc3 <- coeftest(modelo_acr_hazel, vcov = vcovHC(modelo_acr_hazel, type = "HC3"))

tidy(acr_hazel_hc3) %>%
  mutate(term = c("Constante", "Responsabilidade (Hazel)", "IDH", "Desemprego", "Gini")) %>%
  kable(digits = 3,
        col.names = c("Variável", 
                      "Estimativa", 
                      "Erro Padrão", 
                      "t", 
                      "p-valor"),
        align = "c")
```








```{r}
#| eval: false
#| include: false

## ACM_GV

coeftest(modelo_acm_gv, vcov = vcovHC(modelo_acm_gv, type = "HC3"))
```


```{r}
#| eval: false
#| include: false

## ACR_HAZEL

coeftest(modelo_acr_hazel, vcov = vcovHC(modelo_acr_hazel, type = "HC3"))
```

A @tbl-acr-cipriani-hc3 apresenta o erro robusto para o Modelo 4:


```{r}
#| label: tbl-acr-cipriani-hc3
#| echo: false
#| tbl-cap: Estimativas do Modelo ACR Cipriani com Erros Robustos (HC3)

acr_cipriani_hc3 <- coeftest(modelo_acr_cipriani, vcov = vcovHC(modelo_acr_cipriani, type = "HC3"))

tidy(acr_cipriani_hc3) %>%
  mutate(term = c("Constante", "Responsabilidade (Cipriani)", "IDH", "Desemprego", "Gini")) %>%
  kable(digits = 3,
        col.names = c("Variável", 
                      "Estimativa", 
                      "Erro Padrão", 
                      "t", 
                      "p-valor"),
        align = "c")
```

```{r}
#| eval: false
#| include: false

## ACR_CIPRIANI

coeftest(modelo_acr_cipriani, vcov = vcovHC(modelo_acr_cipriani, type = "HC3"))
```




# Referências